# OAuth Testing

This directory contains a full software stack to test `solace-prometheus-exporter` OAuth authentication capabilities, including:

- Prepared self-signed TLS certificates
- A prepared Keycloak instance (with exported realm)
- A Solace instance with a defined SEMP OAuth Profile
- A `bruno` collection to configure the Solace broker
- A `solace-prometheus-exporter` configuration to validate the working OAuth configuration

- [OAuth Testing](#oauth-testing)
  - [TLS certificates](#tls-certificates)
  - [docker compose](#docker-compose)
  - [Keycloak](#keycloak)
    - [Start Keycloak and create user using admin token](#start-keycloak-and-create-user-using-admin-token)
      - [Different export approach](#different-export-approach)
    - [Reuse existing keycloak realm](#reuse-existing-keycloak-realm)
    - [Testing Calls](#testing-calls)
  - [Solace](#solace)

## TLS certificates

Certificates were generated by creating a self-signed CA locally with `openssl`. The CA as well as the certificates are valid for 20 years so you probably won't run into problems with this any time soon.

## docker compose

[docker-compose.yaml](docker-compose.yaml) contains the full stack which is going to spin up a local setup, just run

```bash
$ docker compose up
# [...] truncated output
```

and after everything has started

```bash
curl -vks http://localhost:9628/solace-custom
```

to see metrics being scraped from the SEMP endpoint while `solace-prometheus-exporter` is using OAuth to talk to Solace, and regularly refreshing the token retrieved from Keycloak.

## Keycloak

### Start Keycloak and create user using admin token

```bash
docker network create solace
docker volume create keycloak_data

# Run new Keycloak instance, this will take some time to spin up
docker run --rm --name keycloak \
  -p 8080:8080 \
  -v keycloak_data:/opt/keycloak/data \
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak:26.0.0 \
  start-dev
```

After the instance has spun up, init it with [prepare-keycloak.sh](scripts/prepare-keycloak.sh).

```bash
# Export keycloak test realm with data prepared in last run
docker run --rm \
  -v keycloak_data:/opt/keycloak/data \
  -v $(pwd)/export:/opt/keycloak/export \
  quay.io/keycloak/keycloak:26.0.0 \
  export --dir /opt/keycloak/export --realm test-realm --users realm_file
```

#### Different export approach

```bash
docker exec -ti keycloak bash


/opt/keycloak/bin/kcadm.sh config credentials \
  --server http://localhost:8080 \
  --realm master \
  --user admin \
  --password admin

/opt/keycloak/bin/kcadm.sh get realms/test-realm > /opt/keycloak/test-realm.json

exit

docker cp keycloak:/opt/keycloak/test-realm.json ./prepared-realm.json
```

### Reuse existing keycloak realm

```bash
# Run Keycloak instance with pre-defined realm
docker run --rm --name keycloak \
  -p 8080:8080 \
  --network solace \
  -v $(pwd)/prepared-realm.json:/opt/keycloak/data/import/prepared-realm.json:ro \
  -e KC_BOOTSTRAP_ADMIN_USERNAME=admin \
  -e KC_BOOTSTRAP_ADMIN_PASSWORD=admin \
  quay.io/keycloak/keycloak:26.0.0 \
  start-dev --import-realm

```

### Testing Calls

Test the created identity to retrieve an OAuth token with the necessary scope.

```bash
# Test new created identity to retrieve OAuth token
curl -X POST "http://localhost:8080/realms/test-realm/protocol/openid-connect/token" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "grant_type=client_credentials" \
  -d "client_id=solace-broker" \
  -d "client_secret=my-secret" \
  -d "scope=solace"
```

**Important note:** Calling keycloak with this might work at first because it is configured to explicitly *allow* a different host than the configured one, but this will affect the `iss` field to point to `http://localhost:8080` instead of - for example - `https://keycloak:8443`.

## Solace

For configuring Solace, have a look at the [bruno collection](bruno/) as well as the [oauth checker](scripts/oauth_check.sh) script.
